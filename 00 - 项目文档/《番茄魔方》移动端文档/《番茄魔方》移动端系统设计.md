---

---
--- 
## 一、设计目标与原则

### 1. 核心目标

以 “时间管理 + 专注提升” 为核心，通过极简交互与沉浸式体验，帮助用户培养自律习惯，同时满足个人与团队场景下的专注协作需求，打造差异化的时间管理工具。

### 2. 设计原则

- **用户中心**：优先满足 “专注计时”“任务管理” 核心需求，减少操作步骤（核心功能三步内完成）。
- **差异化体验**：通过 “组队专注”“场景化看板”“AI 分析” 形成竞争壁垒。
- **轻量化设计**：小程序包体控制在 2MB 以内，页面加载时间≤2s，确保流畅体验。
- **商业闭环**：通过 VIP 特权分层（免费功能满足基础需求，付费解锁高级功能）实现可持续运营。

## 二、产品架构设计

### （一）核心业务流程

1. **用户生命周期流程**  
    微信登录→完善个人信息→创建专注 / 任务→使用核心功能→查看统计报告→（付费转化）开通 VIP→持续使用 / 分享邀请
    
2. **核心功能流程**
    
    - **专注流程**：选择时长→单人 / 组队模式→开始专注→计时 / 暂停→完成 / 中断→同步数据至统计
    - **任务流程**：创建任务（打卡 / 纪念日 / 倒计时）→设置提醒→执行 / 完成→标记状态→同步至统计

### （二）功能架构图

plaintext

```plaintext
《番茄魔方》小程序
├─ 基础层（必选功能）
│  ├─ 登录模块（微信快捷登录、用户信息管理）
│  ├─ 通知模块（公众号提醒、系统消息）
│  └─ 配置中心（基础设置、隐私权限）
├─ 核心功能层（免费+付费混合）
│  ├─ 专注模块
│  │  ├─ 免费：5-60min计时、基础白噪音、单人专注
│  │  └─ VIP：120min计时、优质白噪音、组队专注、横屏看板
│  ├─ 任务模块
│  │  ├─ 免费：基础任务管理（CRUD）、简单提醒
│  │  └─ VIP：打卡提醒、特殊周期纪念、日历视图
│  └─ 统计模块
│     ├─ 免费：日/周数据列表、基础图表
│     └─ VIP：AI分析、周/月/年报、多维度排行
└─ 商业层（付费功能）
   ├─ VIP特权（标识、功能解锁、无广告）
   ├─ 付费入口（订阅、激活码兑换）
   └─ 推广体系（邀请返利、分享裂变）
```

## 三、界面架构设计

### （一）页面结构（5 个核心页面 + 8 个辅助页面）

|页面类型|页面名称|核心元素|
|---|---|---|
|核心页面|首页（专注入口）|旋钮式时长选择器、模式切换按钮、快捷功能入口（白噪音、横屏）|
|核心页面|专注计时页|倒计时显示、暂停 / 结束按钮、队友状态（组队时）、白噪音控制器|
|核心页面|任务列表页|任务卡片（分类展示）、创建按钮、筛选器（类型 / 状态）|
|核心页面|统计页|数据概览（专注次数 / 时长）、图表切换、AI 分析卡片|
|核心页面|个人中心页|个人信息、VIP 入口、功能设置、系统入口|
|辅助页面|任务创建 / 编辑页|类型选择器、时间 picker、表单输入框|
|辅助页面|白噪音选择页|音效列表（免费 / VIP 标识）、音量滑块|
|辅助页面|组队页面|队伍列表、创建队伍按钮、队友邀请入口|
|辅助页面|VIP 开通页|套餐选择（月 / 季 / 年）、特权说明、支付按钮|
|其他页面|排行榜、设置页、关于页等|按功能逻辑极简设计|

### （二）设计规范

1. **视觉风格**
    
    - 主色调：浅蓝（#8AB4F8，传递专注、冷静）
    - 辅助色：金色（#FFD700，VIP 标识）、灰色系（功能区分）
    - 风格：浅色模式采用新拟态设计（柔和阴影、圆角元素），深色模式采用扁平化设计（高对比度、简洁线条）
2. **交互规范**
    
    - 操作反馈：按钮点击有凹陷效果（新拟态风格），状态变化有过渡动画（时长≤300ms）。
    - 手势操作：任务卡片右滑删除 / 完成、专注页长按暂停、横屏看板拖拽布局。
    - 导航逻辑：底部 Tab 固定（首页→任务→统计→我的），辅助页面通过 “返回” 按钮退出。
3. **响应式适配**
    
    - 支持 320px-428px 宽度机型（覆盖主流手机），折叠屏适配横屏模式。
    - 字体大小采用`rpx`单位，确保不同屏幕下显示比例一致。

## 四、技术架构设计

### （一）前端架构

- **框架**：微信原生小程序框架（WXML+WXSS+JavaScript），搭配 Tailwind CSS 统一样式。
- **状态管理**：使用`getApp().globalData`管理全局状态（用户信息、登录状态），页面级状态用`data`存储。
- **组件设计**：
    - 基础组件：按钮、输入框、卡片（新拟态风格封装）。
    - 业务组件：时长选择器（旋钮式）、任务卡片（支持左滑 / 拖拽）、白噪音控制器。
- **性能优化**：
    - 图片懒加载（`lazy-load`属性），非首屏资源异步加载。
    - 复杂页面（如统计页）使用`onLoad`预加载数据，`onShow`仅刷新必要内容。

### （二）后端架构

- **框架**：SpringBoot 2.7.x，采用分层架构（Controller→Service→Repository）。
- **接口设计**：RESTful 风格，路径格式`/api/v1/{模块}/{功能}`，返回格式统一：
    
    json
    
    ```json
    {
      "code": 200,        // 状态码（200成功，4xx客户端错，5xx服务端错）
      "msg": "success",   // 提示信息
      "data": {}          // 业务数据
    }
    ```
    
      
    
- **核心服务**：
    - 用户服务：登录认证、信息管理。
    - 专注服务：计时逻辑、组队状态同步、数据校验。
    - 任务服务：CRUD、提醒触发、状态更新。
    - 统计服务：数据聚合、排行计算、报告生成。
- **中间件**：
    - Redis：缓存热点数据（排行榜、用户在线状态），减轻数据库压力。
    - 消息队列（RabbitMQ）：异步处理统计数据计算、公众号通知发送。

### （三）数据库设计

- **核心表结构**（基于用户提供的表优化）：
    - `user_info`：用户基本信息 + VIP 状态。
    - `focus_data`：专注记录（含时长、有效性、队友信息）。
    - `task_data`：任务基础信息（类型、目标时间、状态）。
    - `check_record`：打卡任务的具体记录。
    - `vip_orders`：VIP 订阅订单信息。
    - `stats_summary`：预计算的统计汇总数据（按用户 + 时间维度）。
- **索引策略**：
    - 主键索引：所有表的自增 ID。
    - 外键索引：`uid`（关联用户）、`task_id`（关联任务）。
    - 联合索引：`focus_data(uid, st_time)`（优化用户专注记录查询）、`task_data(uid, status)`（优化任务列表查询）。

### （四）部署架构

- **开发环境**：本地开发 + Git 代码管理，通过 Docker 容器化部署测试环境。
- **生产环境**：
    - 应用服务器：阿里云 ECS（2 核 4G，支持弹性扩容）。
    - 数据库：阿里云 RDS MySQL（主从架构，确保高可用）。
    - 静态资源：阿里云 OSS 存储图片、音频，CDN 加速分发。
    - 监控：阿里云 ARMS 监控接口性能、服务器负载，设置告警阈值（如响应时间 > 3s 告警）。

## 五、关键功能技术实现方案

### （一）专注计时与组队同步

1. **单人专注**：
    
    - 前端记录开始 / 暂停 / 结束时间戳，结束后提交后端。
    - 后端计算总时长，按 “≥设定时长 90%” 判定有效性，存储到`focus_data`。
2. **组队专注**：
    
    - 队长创建队伍时生成唯一`team_id`，队员通过 ID 加入。
    - 采用 WebSocket 实时同步队员状态（在线 / 暂停 / 中断），任一队员中断则全队标记失败。
    - 退出检测：监听小程序`onHide`事件，3 分钟未返回则通过公众号提醒，超时标记失败。

### （二）白噪音与横屏看板

1. **白噪音播放**：
    
    - 前端使用`wx.createInnerAudioContext`控制音频播放，支持切换、暂停、音量调节。
    - VIP 权限校验：播放前检查用户`vip_ddl`，过期则提示开通。
2. **横屏看板**：
    
    - 监听`wx.onWindowResize`事件，检测横屏状态（宽 > 高）。
    - 使用`canvas`绘制虚拟场景，支持拖拽组件（倒计时、任务卡片），坐标通过本地存储记录用户布局偏好。

### （三）数据统计与 AI 分析

1. **统计数据计算**：
    
    - 实时统计：简单数据（如当日专注次数）直接查询`focus_data`。
    - 离线统计：复杂数据（周 / 月排行）通过定时任务（每日凌晨 2 点）计算，结果存储到`stats_summary`。
2. **AI 分析**：
    
    - 前端收集用户数据（专注时长、任务完成率等），后端组装成 prompt。
    - 调用第三方 AI 接口（如 GPT-3.5）生成分析报告，缓存结果避免重复调用。

### （四）公众号通知

1. **触发场景**：专注中断、任务到期、VIP 到期。
2. **实现步骤**：
    - 用户授权时绑定公众号`openid`，存储到`user_info`。
    - 后端通过微信公众号模板消息接口（`sendTemplateMessage`）推送，参数动态填充（如任务名称、剩余时间）。
    - 失败重试：消息发送失败时，存入消息队列，30 分钟后重试（最多 3 次）。

## 六、运营与迭代规划

### （一）测试版上线指标

- 功能完整性：核心流程（专注 + 任务）无阻塞性 bug。
- 性能指标：页面加载≤2s，接口响应≤1s，崩溃率≤0.5%。
- 用户反馈：收集 500 + 有效反馈，NPS（净推荐值）≥40。

### （二）迭代路线图

|阶段|时间|核心目标|关键功能|
|---|---|---|---|
|V1.0|第 1 月|测试版上线，验证核心功能|基础专注 + 任务管理|
|V1.1|第 2 月|完善专注模块，提升用户留存|组队专注、排行榜、横屏看板|
|V1.2|第 3 月|商业化启动，验证付费意愿|VIP 订阅、优质白噪音、AI 分析|
|V1.3|第 4-6 月|扩大用户规模，优化体验|社交裂变、个性化推荐、性能优化|

## 七、风险与应对

|风险类别|具体风险|应对措施|
|---|---|---|
|技术风险|组队专注时网络波动导致状态不同步|实现本地状态缓存 + 定期同步，冲突时以服务器为准|
|体验风险|新用户操作门槛高，流失率高|增加引导页（首次使用）、简化核心操作步骤|
|商业风险|VIP 付费转化率低|提供 7 天免费试用，突出 “组队专注” 等独家功能|
|合规风险|小程序审核不通过（如白噪音版权）|优先使用无版权风险素材，标注 “测试资源”|

  

通过以上设计，《番茄魔方》将实现 “专注 + 任务” 的闭环管理，同时通过差异化功能和清晰的付费体系，在时间管理工具市场中建立独特竞争力。测试版聚焦核心体验验证，后续通过快速迭代持续完善功能，最终打造一款兼顾用户价值与商业价值的产品。